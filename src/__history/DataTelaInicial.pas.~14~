unit DataTelaInicial;

interface

uses
  System.SysUtils, System.Classes, DataConexao, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error,
  FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async,
  FireDAC.DApt, Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Forms;

type
  TdtmTelaInicial = class(TDataModule)
    fdqryUser: TFDQuery;
  private
    { Private declarations }
  public
    function ValidaLogin(Login, Senha: string): Integer;
    procedure FazerLogin(Login: string; Senha: string);
    procedure TestarConexaoBanco();
  end;

var
  dtmTelaInicial: TdtmTelaInicial;

implementation

uses
  Vcl.Dialogs, FormPrincipalBase, FormTelaInicial;

{$R *.dfm}

{ TDataModuleTelaLogin }

procedure TdtmTelaInicial.FazerLogin(Login, Senha: string);
var
  user_id: Integer;
begin
  user_id := ValidaLogin(Login, Senha);

  if user_id = -1 then
  begin
    ShowMessage('Senha ou login incorreto!!');
    Exit;
  end;
  if user_id = -2 then
  begin
    ShowMessage('Altere as configurações para se conectar ao banco de dados.');
    Exit;
  end;

  if not Assigned(PrincipalBase) then
  begin
    PrincipalBase := TPrincipalBase.Create(nil);
  end;

  try
    PrincipalBase.UserId := user_id;
    PrincipalBase.ShowModal;
  finally
    FreeAndNil(PrincipalBase);
  end;
end;

procedure TdtmTelaInicial.TestarConexaoBanco;
begin
  try
    dtmConexao.con.Connected := False;
    dtmConexao.con.Connected := True;
    ShowMessage('Conexão realizada com sucesso!');
  except
    on E: Exception do
      ShowMessage('Erro na conexão: ' + E.Message);
  end;
end;

function TdtmTelaInicial.ValidaLogin(Login, Senha: string): Integer;
var
  auxLogin, auxSenha: string;
  user_id: Integer;
begin
  user_id := -1;
  fdqryUser.Close;
  fdqryuser.ParamByName('pLOGIN').AsString := Login;
  fdqryUser.Open;

  auxLogin := fdqryUser.FieldByName('login').AsString;
  auxSenha := fdqryUser.FieldByName('senha').AsString;

  if (auxLogin = Login) and (auxSenha = Senha) then
  begin
    user_id := fdqryUser.FieldByName('user_id').AsInteger;
  end;

  if (Login = 'admin') and (Senha = '321') then
  begin
    TelaInicial.ntbkTelaInicial.PageIndex := 1;
    user_id := -2;
  end;

  Result := user_id;
end;

end.
